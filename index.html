<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gusto Tax Pro Training - Professional Tax Form Mastery</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <!-- Profile Creation Screen -->
        <div class="screen" id="profile-screen">
            <div class="profile-content">
                <div class="title">
                    <h1>üè¢ Create Your Tax Pro Profile üè¢</h1>
                    <p>Choose your avatar and join the Red Rock Rankings!</p>
                </div>
                
                <div class="profile-form">
                    <div class="name-input-section">
                        <label for="player-name">Your Name:</label>
                        <input type="text" id="player-name" placeholder="Enter your name" maxlength="20" oninput="checkProfileReady()">
                    </div>
                    
                    <div class="avatar-selection">
                        <h3>Choose Your Avatar:</h3>
                        <div class="avatar-options">
                            <!-- Beach Piggy -->
                     
                           <div class="avatar-option" data-avatar="beach" onclick="selectAvatar('beach', this)" style="border: 5px solid red; padding: 20px; margin: 10px; cursor: pointer; background: rgba(255,0,0,0.1);">
                                <div class="preview-piggy beach-preview">
                                    <div class="piggy-body">
                                        <div class="piggy-head">
                                            <div class="piggy-ear ear-left"></div>
                                            <div class="piggy-ear ear-right"></div>
                                            <div class="piggy-eye eye-left"></div>
                                            <div class="piggy-eye eye-right"></div>
                                            <div class="piggy-snout"></div>
                                        </div>
                                        <div class="piggy-legs">
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                        </div>
                                        <div class="piggy-tail"></div>
                                    </div>
                                    <div class="beach-umbrella">
                                        <div class="umbrella-pole"></div>
                                        <div class="umbrella-top"></div>
                                    </div>
                                </div>
                                <div class="avatar-name">Beach Piggy</div>
                            </div>
                            
                            <!-- Penny Piggy -->
                            <div class="avatar-option" data-avatar="penny" onclick="selectAvatar('penny', this)" style="border: 5px solid red; padding: 20px; margin: 10px; cursor: pointer; background: rgba(255,0,0,0.1);">
                                <div class="preview-piggy penny-preview">
                                    <div class="piggy-body">
                                        <div class="piggy-head">
                                            <div class="piggy-ear ear-left"></div>
                                            <div class="piggy-ear ear-right"></div>
                                            <div class="piggy-eye eye-left"></div>
                                            <div class="piggy-eye eye-right"></div>
                                            <div class="piggy-snout"></div>
                                        </div>
                                        <div class="piggy-legs">
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                        </div>
                                        <div class="piggy-tail"></div>
                                    </div>
                                    <div class="penny-coin">
                                        <div class="coin-inner">¬¢</div>
                                    </div>
                                </div>
                                <div class="avatar-name">Penny Piggy</div>
                            </div>
                            
                            <!-- Business Piggy -->
                            <div class="avatar-option" data-avatar="business" onclick="selectAvatar('business', this)" style="border: 5px solid red; padding: 20px; margin: 10px; cursor: pointer; background: rgba(255,0,0,0.1);">
                                <div class="preview-piggy business-preview">
                                    <div class="piggy-body">
                                        <div class="piggy-head">
                                            <div class="piggy-ear ear-left"></div>
                                            <div class="piggy-ear ear-right"></div>
                                            <div class="piggy-eye eye-left"></div>
                                            <div class="piggy-eye eye-right"></div>
                                            <div class="piggy-snout"></div>
                                        </div>
                                        <div class="piggy-legs">
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                        </div>
                                        <div class="piggy-tail"></div>
                                    </div>
                                    <div class="briefcase">
                                        <div class="briefcase-body"></div>
                                        <div class="briefcase-handle"></div>
                                    </div>
                                </div>
                                <div class="avatar-name">Business Piggy</div>
                            </div>
                            
                            <!-- Party Piggy -->
                            <div class="avatar-option" data-avatar="party" onclick="selectAvatar('party', this)" style="border: 5px solid red; padding: 20px; margin: 10px; cursor: pointer; background: rgba(255,0,0,0.1);">
                                <div class="preview-piggy party-preview">
                                    <div class="piggy-body">
                                        <div class="piggy-head">
                                            <div class="piggy-ear ear-left"></div>
                                            <div class="piggy-ear ear-right"></div>
                                            <div class="piggy-eye eye-left"></div>
                                            <div class="piggy-eye eye-right"></div>
                                            <div class="piggy-snout"></div>
                                        </div>
                                        <div class="piggy-legs">
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                            <div class="piggy-leg"></div>
                                        </div>
                                        <div class="piggy-tail"></div>
                                    </div>
                                    <div class="party-decorations">
                                        <div class="confetti"></div>
                                        <div class="confetti"></div>
                                        <div class="confetti"></div>
                                    </div>
                                </div>
                                <div class="avatar-name">Party Piggy</div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="profile-actions">
                        <button class="create-profile-btn" onclick="createUserProfile()" disabled>Create Profile</button>
                        <button class="view-rankings-btn" onclick="showRankings()">View Red Rock Rankings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rankings Screen -->
        <div class="screen" id="rankings-screen" style="display: none;">
            <div class="rankings-content">
                <div class="title">
                    <h1>üèÜ Red Rock Rankings üèÜ</h1>
                    <p>Top Tax Pro Champions</p>
                </div>
                
                <div class="rankings-list" id="rankings-list">
                    <!-- Rankings will be populated by JavaScript -->
                </div>
                
                <div class="rankings-actions">
                    <button class="back-btn" onclick="showProfileScreen()">Back to Profile</button>
                    <button class="start-btn" onclick="startGameFromRankings()">Start Game</button>
                </div>
            </div>
        </div>
        
        <!-- Start Screen -->
        <div class="screen" id="start-screen" style="display: none;">
            <div class="start-screen-content">
                <div class="user-profile-display">
                    <div class="current-user">
                        <div class="user-avatar" id="current-user-avatar"></div>
                        <div class="user-info">
                            <div class="user-name" id="current-user-name">Player</div>
                            <div class="user-best-score">Best: <span id="current-user-best">0</span></div>
                        </div>
                    </div>
                    <button class="change-profile-btn" onclick="showProfileScreen()">Change Profile</button>
                </div>
                
                <div class="title">
                    <h1>üìã Gusto Tax Pro Training üìã</h1>
                    <p>Master IRS 941 and State Tax Forms!</p>
                    <p>Professional tax form training with real-world accuracy requirements!</p>
                </div>
                
                <button onclick="startWorkingGame()" style="background: linear-gradient(45deg, #FF8A65, #FF6B35); color: white; border: none; padding: 20px 40px; cursor: pointer; font-size: 1.3em; border-radius: 25px; box-shadow: 0 4px 15px rgba(255,107,53,0.4); margin: 20px;">üéÆ Start Game</button>
                
                
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="game-screen" style="display: none;">
            <!-- Game UI -->
            <div class="game-ui">
                <div class="ui-left">
                    <div class="score">Score: <span id="score">0</span></div>
                    <div class="level">Level: <span id="level">1</span></div>
                </div>
                <div class="ui-center">
                    <div class="timer">Time: <span id="timer">90</span>s</div>
                </div>
                <div class="ui-right">
                    <div class="forms-completed">Forms: <span id="completed">0</span></div>
                    <div class="game-controls">
                        <button class="exit-btn" onclick="exitToMenu()" title="Exit to Main Menu (ESC)">üö™ Exit</button>
                        <button class="restart-btn" onclick="restartCurrentGame()" title="Restart Current Game">üîÑ Restart</button>
                    </div>
                </div>
            </div>

            <!-- Game Instructions Bar -->
            <div class="game-instructions">
                <div class="instructions-content">
                    <h4>üìã Game Instructions</h4>
                    <p>Fill out the tax form correctly using the PANDA Reference Board. Only correct answers will allow you to submit and advance to the next level!</p>
                </div>
            </div>

            <!-- Main Game Area -->
            <div class="office">
                <!-- Left Side: PANDA Reference Board -->
                <div class="left-panel">
            <div class="panda-board">
                <div class="panda-header">
                    <h3>üêº PANDA Reference Board</h3>
                    <p>Copy this information EXACTLY into the tax forms ‚¨áÔ∏è</p>
                </div>
                
                <div class="panda-content">
                    <div class="panda-section">
                                <h4>üìã Form Data Required</h4>
                        <div class="info-grid">
                                    <div class="info-item highlight">
                                <span class="info-label">EIN:</span>
                                <span class="info-value">94-1234567</span>
                            </div>
                                    <div class="info-item highlight">
                                        <span class="info-label">Business Name:</span>
                                        <span class="info-value">Gusto Payroll Solutions</span>
                            </div>
                                    <div class="info-item highlight">
                                <span class="info-label">Total Wages:</span>
                                        <span class="info-value">125000</span>
                            </div>
                                    <div class="info-item highlight">
                                <span class="info-label">Federal Income Tax:</span>
                                        <span class="info-value">18750</span>
                            </div>
                                    <div class="info-item highlight">
                                <span class="info-label">Social Security Tax:</span>
                                        <span class="info-value">7750</span>
                            </div>
                                    <div class="info-item highlight">
                                <span class="info-label">Medicare Tax:</span>
                                        <span class="info-value">1812</span>
                            </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side: Form Area -->
                <div class="right-panel">

                    <!-- Form Display -->
                    <div class="form-container">
                        <div class="form" id="current-form">
                            <!-- Form content will be generated by JavaScript -->
                        </div>
                    </div>

                    <!-- Form Actions Container -->
                    <div class="form-actions">
                        <button class="action-btn" id="fill-btn" onclick="fillForm()">üñäÔ∏è FILL FORM</button>
                        
                        <!-- Submit Button -->
                        <button class="action-btn submit-form-btn" id="submit-form-btn" onclick="submitUltraSimpleForm()" style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; display: none;">
                            üöÄ SUBMIT FORM
                        </button>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Game Over Screen -->
        <div class="screen" id="game-over-screen" style="display: none;">
            <div class="game-over-content">
                <h2 id="game-over-title">Time's Up!</h2>
                <div class="final-stats">
                    <div class="stat">Final Score: <span id="final-score">0</span></div>
                    <div class="stat">Level Reached: <span id="final-level">1</span></div>
                    <div class="stat">Forms Completed: <span id="final-forms">0</span></div>
                    <div class="stat">Accuracy: <span id="accuracy">0%</span></div>
                </div>
                <div class="rating" id="rating"></div>
                <button class="restart-btn" onclick="restartGame()">Play Again</button>
                <button class="menu-btn" onclick="showStartScreen()">Main Menu</button>
            </div>
        </div>
    </div>

    <!-- All audio is now generated synthetically using Web Audio API -->

    <!-- Audio Controls -->
    <div id="audio-controls">
        <button id="music-toggle" title="Toggle Background Music - Music plays during gameplay">üéµ</button>
        <button id="sfx-toggle" title="Toggle Sound Effects - Hear dings when filling forms">üîä</button>
        <input type="range" id="volume-slider" min="0" max="100" value="70" title="Volume Control">
    </div>

        <script>
            console.log('üöÄ HTML LOADED - About to load game script');
            console.log('Time before script:', new Date().toLocaleTimeString());
        </script>
        
        <!-- LOAD THE ACTUAL GAME SCRIPT FILE -->
        <script src="game-simplified.js"></script>
        
        <script>
            // Main script starting
            console.log('üöÄ Main script starting...');
            
            // Test if game-simplified.js loaded successfully
            console.log('üß™ game-simplified.js should be loaded now!');
            if (typeof window.fillForm === 'function') {
                console.log('‚úÖ SUCCESS: fillForm() function is available!');
            } else {
                console.log('‚ùå ERROR: fillForm() function not found!');
            }
        </script>
        <script>
            console.log('üß™ EMERGENCY: Loading ultra-simple script');
            
            // Ultra-minimal functions
            let selectedAvatarGlobal = null;
            
            function selectAvatar(avatarType, element) {
                console.log('Avatar selected:', avatarType);
                selectedAvatarGlobal = avatarType;
                
                // Remove selection from all avatars
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.style.border = '5px solid red';
                    option.style.backgroundColor = 'rgba(255,0,0,0.1)';
                });
                
                // Select this avatar
                if (element) {
                    element.style.border = '5px solid gold';
                    element.style.backgroundColor = 'rgba(255,215,0,0.3)';
                    console.log('‚úÖ Avatar visually selected:', avatarType);
                }
                
                // Call the checkProfileReady function to update button state
                checkProfileReady();
            }
            
            function createUserProfile() {
                const nameInput = document.getElementById('player-name');
                const playerName = nameInput ? nameInput.value.trim() : '';
                
                console.log('üìã Profile creation attempt:', {
                    name: playerName,
                    avatar: selectedAvatarGlobal
                });
                
                if (playerName && selectedAvatarGlobal) {
                    // Create profile
                    const profile = {
                        name: playerName,
                        avatar: selectedAvatarGlobal,
                        bestScore: 0,
                        totalGames: 0,
                        dateCreated: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('taxProUser', JSON.stringify(profile));
                    console.log('‚úÖ Profile saved:', profile);
                    
                    // Show start screen
                    const profileScreen = document.getElementById('profile-screen');
                    const startScreen = document.getElementById('start-screen');
                    
                    if (profileScreen) profileScreen.style.display = 'none';
                    if (startScreen) startScreen.style.display = 'flex';
                    
                    // Update user display
                    const userNameEl = document.getElementById('current-user-name');
                    const userBestEl = document.getElementById('current-user-best');
                    const userAvatarEl = document.getElementById('current-user-avatar');
                    
                    if (userNameEl) userNameEl.textContent = playerName;
                    if (userBestEl) userBestEl.textContent = '0';
                    if (userAvatarEl) userAvatarEl.innerHTML = selectedAvatarGlobal;
                    
                    console.log('‚úÖ Profile created! Now showing start screen.');
                } else {
                    // Show error message
                    const errorMsg = `Missing: ${!playerName ? 'name' : ''} ${!selectedAvatarGlobal ? 'avatar' : ''}`;
                    console.log('‚ùå Profile creation failed:', errorMsg);
                    alert('Please enter your name and select an avatar!');
                }
            }
            
            function checkProfileReady() {
                // Called when name is typed
                const nameInput = document.getElementById('player-name');
                const createBtn = document.querySelector('.create-profile-btn');
                
                if (nameInput && createBtn) {
                    const playerName = nameInput.value.trim();
                    
                    if (playerName && selectedAvatarGlobal) {
                        createBtn.disabled = false;
                        createBtn.style.background = 'linear-gradient(45deg, #66BB6A, #4CAF50)';
                        createBtn.style.opacity = '1';
                        createBtn.style.cursor = 'pointer';
                    } else {
                        createBtn.disabled = true;
                        createBtn.style.background = '#ccc';
                        createBtn.style.opacity = '0.6';
                        createBtn.style.cursor = 'not-allowed';
                    }
                }
            }

            // Game control functions for exit and restart buttons
            function exitToMenu() {
                console.log('üö™ Exit to menu clicked');
                if (game) {
                    game.showStartScreen();
                } else {
                    // Fallback if game object doesn't exist
                    const screens = ['profile-screen', 'rankings-screen', 'game-screen', 'game-over-screen'];
                    screens.forEach(screenId => {
                        const screen = document.getElementById(screenId);
                        if (screen) {
                            screen.style.display = screenId === 'start-screen' ? 'flex' : 'none';
                        }
                    });
                    
                    const startScreen = document.getElementById('start-screen');
                    if (startScreen) startScreen.style.display = 'flex';
                }
            }

            function restartCurrentGame() {
                console.log('üîÑ Restart game clicked');
                if (game) {
                    game.restartGame();
                } else {
                    // Fallback if game object doesn't exist
                    location.reload();
                }
            }
            
            // Game state
            let gameState = 'menu';
            let gameTimer = null;
            let timeLeft = 90; // Increased from 30 to 90 seconds
            let currentLevel = 1;
            let currentScore = 0;
            let formsCompleted = 0;
            let formState = 'empty'; // empty, filled, reviewed, submitted
            
            // Audio system
            let audioContext = null;
            let backgroundMusic = null;
            let musicEnabled = true;
            let sfxEnabled = true;
            let masterVolume = 0.7;
            
            // PANDA reference data - completely different data for each level
            function getPandaData() {
                const formLevel = ((currentLevel - 1) % 5) + 1;
                
                switch (formLevel) {
                    case 1: // Federal IRS 941
                        return {
                            companyName: "Gusto Payroll Solutions",
                            ein: "94-1234567",
                            totalWages: "125000",
                            federalIncomeTax: "18750",
                            socialSecurityTax: "7750",
                            medicareTax: "1812",
                            jurisdiction: "Federal IRS"
                        };
                        
                    case 2: // California DE 9
                        return {
                            companyName: "Golden State Tech Inc",
                            ein: "77-9876543", 
                            employerAccount: "123-4567-8",
                            totalWages: "98500",
                            unemploymentInsurance: "2955",
                            employmentTrainingTax: "295",
                            stateDisabilityInsurance: "985",
                            jurisdiction: "California EDD"
                        };
                        
                    case 3: // New York NYS-45
                        return {
                            companyName: "Empire Business Corp",
                            ein: "22-5555444",
                            nysTaxId: "W-123456789",
                            totalWages: "156750",
                            nyStateIncomeTax: "9405",
                            unemploymentInsurance: "1567",
                            reemploymentServiceFund: "78",
                            jurisdiction: "New York State"
                        };
                        
                    case 4: // Texas C-3
                        return {
                            companyName: "Lone Star Enterprises",
                            ein: "88-7412589",
                            texasId: "12345678901234",
                            totalWages: "134200",
                            unemploymentTax: "2684",
                            employmentAndTraining: "134",
                            skillsDevelopment: "26",
                            jurisdiction: "Texas Workforce Commission"
                        };
                        
                    case 5: // Illinois UI-3/40
                        return {
                            companyName: "Prairie Industries LLC",
                            ein: "33-9988776",
                            illinoisId: "1234567-890",
                            totalWages: "142800",
                            unemploymentInsurance: "3570",
                            stateIncomeTax: "7140",
                            workersCompensation: "1428",
                            jurisdiction: "Illinois Department of Revenue"
                        };
                        
                    default:
                        return getPandaData(); // Recursively call for level cycle
                }
            }
            
            function startGame() {
                console.log('üéÆ Starting game...');
                console.log('Window.game available:', !!window.game);
                console.log('Game object type:', typeof window.game);
                console.log('Local game variable:', typeof game);
                console.log('TaxFilingGame class:', typeof TaxFilingGame);
                
                // Always use manual start for now to ensure it works
                console.log('Using manual game start to ensure it works');
                startGameManually();
            }
            
            function startGameManually() {
                console.log('üéÆ ULTRA SIMPLE GAME START...');
                
                // 1. Hide other screens, show game screen
                document.getElementById('profile-screen').style.display = 'none';
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                console.log('‚úÖ Screens switched');
                
                // 2. Set simple game variables
                timeLeft = 90;
                currentLevel = 1;
                currentScore = 0;
                formsCompleted = 0;
                console.log('‚úÖ Game variables set');
                
                // 3. Update the UI numbers
                document.getElementById('score').textContent = currentScore;
                document.getElementById('level').textContent = currentLevel;
                document.getElementById('timer').textContent = timeLeft;
                document.getElementById('completed').textContent = formsCompleted;
                console.log('‚úÖ UI updated');
                
                // 4. Start the timer
                if (gameTimer) clearInterval(gameTimer);
                gameTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').textContent = timeLeft;
                    console.log('Timer:', timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(gameTimer);
                        alert('Time up!');
                    }
                }, 1000);
                console.log('‚úÖ Timer started');
                
                // 5. Create the form
                createUltraSimpleForm();
                
                console.log('üéâ ULTRA SIMPLE GAME STARTED!');
            }
            
            // Timer already handled in startGameManually - this is old version
            
            // UI updates now done inline - this is old version
            
            // Different forms for different levels
            const formTypes = {
                1: { title: 'IRS Form 941 - Quarterly Federal Tax Return', number: '941', type: 'Federal' },
                2: { title: 'California DE 9 - Quarterly Contribution Return', number: 'DE 9', type: 'California' },
                3: { title: 'New York NYS-45 - Quarterly Combined Withholding', number: 'NYS-45', type: 'New York' },
                4: { title: 'Texas C-3 - Employer\'s Quarterly Tax Report', number: 'C-3', type: 'Texas' },
                5: { title: 'Illinois UI-3/40 - Quarterly Tax and Wage Report', number: 'UI-3/40', type: 'Illinois' }
            };
            
            
            function updatePandaBoard() {
                const pandaContent = document.querySelector('.panda-content');
                if (!pandaContent) {
                    console.warn('PANDA content area not found!');
                    return;
                }
                
                const currentPandaData = getPandaData();
                console.log(`üêº Updating PANDA board for level ${currentLevel}:`, currentPandaData);
                
                // Create simplified PANDA board with only the essential form data
                let pandaHTML = `
                    <div class="panda-section">
                        <h4>üìã Form Data Required</h4>
                        <div class="info-grid">
                            <div class="info-item highlight">
                                <span class="info-label">EIN:</span>
                                <span class="info-value">${currentPandaData.ein}</span>
                    </div>
                            <div class="info-item highlight">
                                <span class="info-label">Business Name:</span>
                                <span class="info-value">${currentPandaData.companyName}</span>
                            </div>
                            <div class="info-item highlight">
                                <span class="info-label">Total Wages:</span>
                                <span class="info-value">${currentPandaData.totalWages}</span>
                            </div>
                            <div class="info-item highlight">
                                <span class="info-label">Federal Income Tax:</span>
                                <span class="info-value">${currentPandaData.federalIncomeTax}</span>
                            </div>
                            <div class="info-item highlight">
                                <span class="info-label">Social Security Tax:</span>
                                <span class="info-value">${currentPandaData.socialSecurityTax}</span>
                            </div>
                            <div class="info-item highlight">
                                <span class="info-label">Medicare Tax:</span>
                                <span class="info-value">${currentPandaData.medicareTax}</span>
                            </div>
                        </div>
                        </div>
                    `;
                
                pandaContent.innerHTML = pandaHTML;
                
                // Add visual feedback that the board updated
                pandaContent.style.border = '3px solid #FFD700';
                setTimeout(() => {
                    pandaContent.style.border = '';
                }, 1000);
            }
            
            // updateActionButtons function moved to after game-simplified.js loads
            
            // Game action functions will be defined after game-simplified.js loads
            
            // Old submit function replaced by submitUltraSimpleForm
            
            function reviewForm() {
                console.log('üîç Review Form clicked');
                if (window.formState !== 'filled') return;
                
                window.formState = 'reviewed';
                updateActionButtons();
                console.log('‚úÖ Form reviewed');
            }
            
            
            // Audio System Implementation
            function initializeAudio() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('üéµ Audio context initialized');
                    setupAudioControls();
                } catch (error) {
                    console.error('Failed to initialize audio:', error);
                }
            }
            
            function setupAudioControls() {
                const musicToggle = document.getElementById('music-toggle');
                const sfxToggle = document.getElementById('sfx-toggle');
                const volumeSlider = document.getElementById('volume-slider');
                
                if (musicToggle) {
                    musicToggle.addEventListener('click', () => {
                        musicEnabled = !musicEnabled;
                        musicToggle.textContent = musicEnabled ? 'üéµ' : 'üîá';
                        if (musicEnabled && gameState === 'playing') {
                            startBackgroundMusic();
                        } else {
                            stopBackgroundMusic();
                        }
                    });
                }
                
                if (sfxToggle) {
                    sfxToggle.addEventListener('click', () => {
                        sfxEnabled = !sfxEnabled;
                        sfxToggle.textContent = sfxEnabled ? 'üîä' : 'üîá';
                    });
                }
                
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => {
                        masterVolume = e.target.value / 100;
                    });
                }
            }
            
            function startBackgroundMusic() {
                if (!audioContext || !musicEnabled || backgroundMusic) return;
                
                try {
                    // Mario-style chord progression
                    const chords = [
                        [261.63, 329.63, 392.00], // C major
                        [293.66, 369.99, 440.00], // D minor
                        [349.23, 415.30, 493.88], // F major
                        [261.63, 329.63, 392.00], // C major
                    ];
                    
                    let chordIndex = 0;
                    
                    function playChord() {
                        if (!musicEnabled || !audioContext) return;
                        
                        const chord = chords[chordIndex % chords.length];
                        chordIndex++;
                        
                        chord.forEach((freq, i) => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = freq;
                            oscillator.type = 'square'; // Mario-style square wave
                            
                            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(masterVolume * 0.1, audioContext.currentTime + 0.05);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                            
                            oscillator.start(audioContext.currentTime + i * 0.1);
                            oscillator.stop(audioContext.currentTime + 0.8);
                        });
                        
                        // Schedule next chord
                        setTimeout(playChord, 1000);
                    }
                    
                    backgroundMusic = playChord;
                    playChord();
                    console.log('üéµ Background music started');
                    
                } catch (error) {
                    console.error('Failed to start background music:', error);
                }
            }
            
            function stopBackgroundMusic() {
                backgroundMusic = null;
                console.log('üéµ Background music stopped');
            }
            
            function playDingSound() {
                if (!audioContext || !sfxEnabled) return;
                
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(masterVolume * 0.3, audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    
                    console.log('üîî Ding sound played');
                } catch (error) {
                    console.error('Failed to play ding sound:', error);
                }
            }
            
            function playSuccessSound() {
                if (!audioContext || !sfxEnabled) return;
                
                try {
                    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                    
                    notes.forEach((freq, i) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = freq;
                        oscillator.type = 'triangle';
                        
                        const startTime = audioContext.currentTime + i * 0.1;
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(masterVolume * 0.2, startTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + 0.3);
                    });
                    
                    console.log('üéâ Success sound played');
                } catch (error) {
                    console.error('Failed to play success sound:', error);
                }
            }
            
            // Rankings System Implementation
            function showRankings() {
                console.log('üìä Showing rankings screen');
                
                // Hide all other screens
                const screens = ['profile-screen', 'start-screen', 'game-screen', 'game-over-screen'];
                screens.forEach(screenId => {
                    const screen = document.getElementById(screenId);
                    if (screen) screen.style.display = 'none';
                });
                
                // Show rankings screen
                const rankingsScreen = document.getElementById('rankings-screen');
                if (rankingsScreen) {
                    rankingsScreen.style.display = 'flex';
                    displayRankings();
                }
            }
            
            function displayRankings() {
                const rankingsList = document.getElementById('rankings-list');
                if (!rankingsList) {
                    console.warn('Rankings list element not found');
                    return;
                }
                
                // Get all saved user scores from localStorage
                const rankings = getRankings();
                console.log('üìä Current rankings:', rankings);
                
                let rankingsHTML = '';
                
                if (rankings.length === 0) {
                    rankingsHTML = `
                        <div class="no-rankings">
                            <h3>üèÜ No Rankings Yet!</h3>
                            <p>Be the first to complete the tax training and get on the Red Rock Rankings!</p>
                        </div>
                    `;
                } else {
                    rankingsHTML = '<div class="rankings-header"><h3>üèÜ Red Rock Tax Pro Champions</h3></div>';
                    
                    rankings.forEach((user, index) => {
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                        const avatarName = user.avatar ? user.avatar.charAt(0).toUpperCase() + user.avatar.slice(1) : 'Unknown';
                        
                        rankingsHTML += `
                            <div class="ranking-entry ${index < 3 ? 'top-three' : ''}">
                                <div class="rank-position">${medal} #${index + 1}</div>
                                <div class="rank-info">
                                    <div class="rank-name">${user.name}</div>
                                    <div class="rank-details">
                                        <span class="rank-avatar">${avatarName} Avatar</span>
                                        <span class="rank-score">Best Score: ${user.bestScore.toLocaleString()}</span>
                                    </div>
                                    <div class="rank-stats">
                                        <span>Games: ${user.totalGames || 0}</span>
                                        <span>Date: ${new Date(user.dateCreated).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                rankingsList.innerHTML = rankingsHTML;
            }
            
            function getRankings() {
                try {
                    // Get all users from localStorage and sort by best score
                    const allUsers = [];
                    
                    // Check for current user
                    const currentUser = localStorage.getItem('taxProUser');
                    if (currentUser) {
                        allUsers.push(JSON.parse(currentUser));
                    }
                    
                    // Add some sample rankings if no real data exists
                    if (allUsers.length === 0) {
                        return [
                            { name: 'Tax Master Pro', avatar: 'business', bestScore: 2500, totalGames: 15, dateCreated: new Date('2024-01-15').toISOString() },
                            { name: 'Form Filler Elite', avatar: 'penny', bestScore: 2200, totalGames: 12, dateCreated: new Date('2024-02-01').toISOString() },
                            { name: 'Compliance Queen', avatar: 'party', bestScore: 1900, totalGames: 8, dateCreated: new Date('2024-02-15').toISOString() },
                            { name: 'Audit Ace', avatar: 'beach', bestScore: 1750, totalGames: 10, dateCreated: new Date('2024-03-01').toISOString() },
                            { name: 'Deduction Detective', avatar: 'business', bestScore: 1600, totalGames: 6, dateCreated: new Date('2024-03-10').toISOString() }
                        ];
                    }
                    
                    // Sort by best score (highest first)
                    return allUsers.sort((a, b) => (b.bestScore || 0) - (a.bestScore || 0));
                    
                } catch (error) {
                    console.error('Error getting rankings:', error);
                    return [];
                }
            }
            
            function showProfileScreen() {
                console.log('üë§ Showing profile screen');
                
                // Hide all other screens
                const screens = ['rankings-screen', 'start-screen', 'game-screen', 'game-over-screen'];
                screens.forEach(screenId => {
                    const screen = document.getElementById(screenId);
                    if (screen) screen.style.display = 'none';
                });
                
                // Show profile screen
                const profileScreen = document.getElementById('profile-screen');
                if (profileScreen) {
                    profileScreen.style.display = 'flex';
                }
            }
            
            function startGameFromRankings() {
                console.log('üéÆ Starting game from rankings');
                showProfileScreen();
            }
            
            console.log('‚úÖ Game with rankings system loaded');
        </script>
        <script>
            // Fallback to minimal if main script fails
            setTimeout(() => {
                if (typeof selectAvatar === 'undefined') {
                    console.error('‚ùå Main script failed, loading minimal fallback...');
                    const script = document.createElement('script');
                    script.src = 'minimal-game.js';
                    document.head.appendChild(script);
                }
            }, 100);
        </script>
        <script>
            console.log('‚úÖ AFTER SCRIPT - Script should be loaded now');
            console.log('Time after script:', new Date().toLocaleTimeString());
            console.log('selectAvatar function exists:', typeof selectAvatar);
            console.log('createUserProfile function exists:', typeof createUserProfile);
            console.log('game object exists:', typeof game);
            
            // Ensure game object is available
            function ensureGameObject() {
                if (!window.game) {
                    console.log('‚ö†Ô∏è Game object not found, attempting to create...');
                    // Try to create a minimal game object if the main one failed
                    if (typeof TaxFilingGame !== 'undefined') {
                        window.game = new TaxFilingGame();
                        console.log('‚úÖ Game object created successfully');
                    } else if (typeof game !== 'undefined' && game) {
                        // Use the local game variable if it exists
                        window.game = game;
                        console.log('‚úÖ Game object assigned from local variable');
                    } else {
                        console.log('‚ùå TaxFilingGame class not available');
                    }
                } else {
                    console.log('‚úÖ Game object is available');
                }
            }
            
            // Check for game object after a short delay
            setTimeout(ensureGameObject, 500);
            setTimeout(ensureGameObject, 1000);
            setTimeout(ensureGameObject, 2000);
            
            
            
            // Add input listener for name field - wait for DOM to be ready
            function attachEventListeners() {
                const nameInput = document.getElementById('player-name');
                if (nameInput) {
                    // Remove any existing listeners first
                    nameInput.removeEventListener('input', checkProfileReady);
                    nameInput.removeEventListener('keyup', checkProfileReady);
                    
                    // Add new listeners
                    nameInput.addEventListener('input', checkProfileReady);
                    nameInput.addEventListener('keyup', checkProfileReady);
                }
                
                // Also add onclick handlers to avatar buttons
                const avatarOptions = document.querySelectorAll('.avatar-option');
                avatarOptions.forEach((option) => {
                    const avatarType = option.getAttribute('data-avatar');
                    
                    // Remove existing onclick and add new event listener
                    option.onclick = null;
                    option.addEventListener('click', function() {
                        selectAvatar(avatarType, this);
                    });
                });
            }
            
            // Try to attach listeners immediately
            attachEventListeners();
            
            // Also try after DOM is loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachEventListeners);
            }
            
            // Try again after a short delay to make sure everything is loaded
            setTimeout(attachEventListeners, 1000);
            
            // Define updateActionButtons function first
            function updateActionButtons() {
                const fillBtn = document.getElementById('fill-btn');
                const submitBtn = document.getElementById('submit-form-btn');
                
                if (!fillBtn || !submitBtn) {
                    return;
                }
                
                switch (window.formState) {
                    case 'empty':
                        fillBtn.disabled = false;
                        fillBtn.style.display = 'inline-block';
                        submitBtn.style.display = 'none';
                        break;
                    case 'filled':
                        fillBtn.disabled = true;
                        fillBtn.style.display = 'none';
                        submitBtn.style.display = 'inline-block';
                        submitBtn.disabled = true; // Initially disabled until form is validated
                        submitBtn.style.opacity = '0.5';
                        submitBtn.style.cursor = 'not-allowed';
                        submitBtn.title = 'Please fill out the form correctly to enable submission.';
                        break;
                    case 'reviewed':
                        fillBtn.disabled = true;
                        fillBtn.style.display = 'none';
                        submitBtn.style.display = 'inline-block';
                        submitBtn.disabled = false;
                        break;
                    default:
                        // Force show submit button for unexpected states
                        submitBtn.style.display = 'inline-block';
                        submitBtn.disabled = false;
                        break;
                }
            }
            
            // Form validation function
            function validateForm() {
                const inputs = document.querySelectorAll('#current-form input');
                const errors = [];
                let allCorrect = true;
                
                // Get current level data for validation
                let pandaData;
                if (typeof getPandaData === 'function') {
                    pandaData = getPandaData();
                    } else {
                    // Fallback test data
                    pandaData = {
                        ein: '94-1234567',
                        totalWages: '125000',
                        federalIncomeTax: '18750',
                        socialSecurityTax: '7750',
                        medicareTax: '1812'
                    };
                }
                
                inputs.forEach(input => {
                    const fieldId = input.id;
                    const userValue = input.value.trim();
                    const correctValue = getCorrectValue(fieldId, pandaData);
                    
                    // Debug logging for field validation
                    console.log(`üîç Field ${fieldId}: user="${userValue}", correct="${correctValue}"`);
                    
                    
                    // Clear previous validation styling and animations
                    input.style.border = '';
                    input.style.backgroundColor = '';
                    input.style.boxShadow = '';
                    input.style.animation = '';
                    input.classList.remove('field-correct', 'field-incorrect', 'field-empty');
                    
                    if (userValue === '') {
                        // Empty field - show neutral styling
                        input.classList.add('field-empty');
                        input.style.border = '2px solid #ffa726';
                        input.style.backgroundColor = '#fff3e0';
                        return;
                    }
                    
                    if (correctValue && userValue !== correctValue) {
                        // Incorrect answer - strong visual feedback
                        input.classList.add('field-incorrect');
                        input.style.border = '3px solid #f44336';
                        input.style.backgroundColor = '#ffebee';
                        input.style.boxShadow = '0 0 10px rgba(244, 67, 54, 0.5)';
                        input.style.animation = 'shake 0.5s ease-in-out';
                        errors.push(`${fieldId}: "${userValue}" should be "${correctValue}"`);
                        allCorrect = false;
                    } else if (correctValue && userValue === correctValue) {
                        // Correct answer - positive visual feedback
                        input.classList.add('field-correct');
                        input.style.border = '3px solid #4CAF50';
                        input.style.backgroundColor = '#e8f5e8';
                        input.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.5)';
                        input.style.animation = 'pulse 0.3s ease-in-out';
                    }
                });
                
                return { allCorrect, errors };
            }
            
            // Get correct value for a field based on PANDA data
            function getCorrectValue(fieldId, pandaData) {
                // Map field IDs to PANDA data based on the form generation
                const fieldMap = {
                    'field-0': pandaData.ein,                    // EIN
                    'field-1': pandaData.totalWages,             // Total Wages
                    'field-2': pandaData.federalIncomeTax,       // Federal Income Tax
                    'field-3': pandaData.socialSecurityTax,      // Social Security Tax
                    'field-4': pandaData.medicareTax             // Medicare Tax
                };
                
                return fieldMap[fieldId] || null;
            }
            
            // ULTRA SIMPLE form that definitely works
            function createUltraSimpleForm() {
                console.log('üéØ Creating ULTRA SIMPLE form');
                
                const formElement = document.getElementById('current-form');
                if (!formElement) {
                    console.error('‚ùå Form element not found!');
                    return;
                }
                
                // Create the simplest possible form
                formElement.innerHTML = `
                    <h3>Tax Form - Level ${currentLevel}</h3>
                    <div style="margin: 20px 0;">
                        <label>EIN: </label>
                        <input type="text" id="field-0" placeholder="94-1234567" style="margin: 5px; padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label>Total Wages: </label>
                        <input type="text" id="field-1" placeholder="125000.00" style="margin: 5px; padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label>Federal Income Tax: </label>
                        <input type="text" id="field-2" placeholder="18750.00" style="margin: 5px; padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label>Social Security Tax: </label>
                        <input type="text" id="field-3" placeholder="7750.00" style="margin: 5px; padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <div style="margin: 20px 0;">
                        <label>Medicare Tax: </label>
                        <input type="text" id="field-4" placeholder="1812.50" style="margin: 5px; padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <button id="submit-form-btn" onclick="submitUltraSimpleForm()" style="display: none; padding: 15px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; cursor: pointer; margin: 20px 0;">
                        üöÄ SUBMIT FORM
                    </button>
                `;
                
                console.log('‚úÖ Ultra simple form created');
                
                // Add simple validation
                const inputs = document.querySelectorAll('#current-form input');
                const correctAnswers = ['94-1234567', '125000.00', '18750.00', '7750.00', '1812.50'];
                
                inputs.forEach((input, index) => {
                    input.addEventListener('input', () => {
                        const value = input.value.trim();
                        const correct = correctAnswers[index];
                        
                        console.log(`Field ${index}: "${value}" vs "${correct}"`);
                        
                        if (value === correct) {
                            input.style.border = '3px solid #00ff00';
                            input.style.background = '#f0fff0';
                            console.log(`‚úÖ Field ${index} GREEN`);
                        } else if (value !== '') {
                            input.style.border = '3px solid #ff0000';
                            input.style.background = '#fff0f0';
                            console.log(`‚ùå Field ${index} RED`);
                        } else {
                            input.style.border = '2px solid #ddd';
                            input.style.background = 'white';
                        }
                        
                        // Check if all filled and correct
                        let allCorrect = true;
                        let allFilled = true;
                        inputs.forEach((inp, i) => {
                            if (!inp.value.trim()) allFilled = false;
                            if (inp.value.trim() !== correctAnswers[i]) allCorrect = false;
                        });
                        
                        const submitBtn = document.getElementById('submit-form-btn');
                        if (allFilled) {
                            submitBtn.style.display = 'block';
                            if (allCorrect) {
                                submitBtn.textContent = 'üöÄ SUBMIT - ALL CORRECT!';
                                submitBtn.style.background = '#4CAF50';
                            } else {
                                submitBtn.textContent = '‚ö†Ô∏è SUBMIT ANYWAY';
                                submitBtn.style.background = '#ff9800';
                            }
                        } else {
                            submitBtn.style.display = 'none';
                        }
                    });
                });
                
                console.log('‚úÖ Ultra simple validation added');
            }
            
            // Ultra simple submit function
            function submitUltraSimpleForm() {
                console.log('üöÄ Form submitted!');
                
                // Add points and advance level
                currentScore += 100;
                currentLevel++;
                formsCompleted++;
                timeLeft += 15; // Bonus time
                
                // Update UI
                document.getElementById('score').textContent = currentScore;
                document.getElementById('level').textContent = currentLevel;
                document.getElementById('completed').textContent = formsCompleted;
                
                alert(`üéâ Level Complete! 
Score: ${currentScore}
Now Level: ${currentLevel}
+15 seconds bonus time!`);
                
                // Create new form for next level
                createUltraSimpleForm();
                
                console.log('‚úÖ Advanced to level', currentLevel);
            }
            
            // TEST FUNCTION - Call this from console to test everything
            function testGame() {
                console.log('üß™ TESTING ULTRA SIMPLE GAME...');
                
                // Test 1: Check if elements exist
                console.log('Test 1: Elements');
                console.log('  - Game screen:', !!document.getElementById('game-screen'));
                console.log('  - Form element:', !!document.getElementById('current-form'));
                console.log('  - Timer element:', !!document.getElementById('timer'));
                
                // Test 2: Start game
                console.log('Test 2: Starting game...');
                startGameManually();
                
                // Test 3: Check after 2 seconds
                setTimeout(() => {
                    console.log('Test 3: After game start');
                    console.log('  - Game screen visible:', document.getElementById('game-screen').style.display === 'block');
                    console.log('  - Form inputs:', document.querySelectorAll('#current-form input').length);
                    console.log('  - Timer value:', document.getElementById('timer').textContent);
                }, 2000);
                
                console.log('‚úÖ Test started - check console in 2 seconds');
            }
            
            // Setup normal game flow - profile first, then game
            window.addEventListener('load', () => {
                console.log('üéÆ Loading normal game flow...');
                
                // Kill any existing timers
                if (window.gameTimer) clearInterval(window.gameTimer);
                if (window.timer) clearInterval(window.timer);
                
                // Override any existing functions that might interfere with our working game
                window.generateForm = function() { console.log('generateForm blocked - using simple game'); };
                window.renderForm = function() { console.log('renderForm blocked - using simple game'); };
                window.generateNewForm = function() { console.log('generateNewForm blocked - using simple game'); };
                
                // Show profile screen first (normal flow)
                setTimeout(() => {
                    console.log('‚úÖ Showing profile creation screen');
                    showProfileScreen();
                }, 1000);
            });
            
            // Show profile screen function
            function showProfileScreen() {
                const profileScreen = document.getElementById('profile-screen');
                const startScreen = document.getElementById('start-screen');
                const gameScreen = document.getElementById('game-screen');
                
                if (profileScreen) profileScreen.style.display = 'flex';
                if (startScreen) startScreen.style.display = 'none';
                if (gameScreen) gameScreen.style.display = 'none';
                
                console.log('üìã Profile screen shown - enter name and choose avatar');
            }
            
            // Enhanced start game function (called from Start Game button)
            function startWorkingGame() {
                console.log('üéÆ Starting working game with profile...');
                
                // Get user profile info
                const playerName = document.getElementById('player-name')?.value?.trim() || 'Player';
                const avatar = window.selectedAvatarGlobal || 'üë§';
                
                console.log(`Player: ${playerName}, Avatar: ${avatar}`);
                
                // Reset game progress flag for fresh start
                window.gameInProgress = false;
                
                // Now start the working game
                forceSimpleGame();
            }
            
            // COMPLETELY ISOLATED SIMPLE GAME
            function forceSimpleGame() {
                console.log('üö® FORCE SIMPLE GAME START');
                
                // 1. Force show game screen
                const gameScreen = document.getElementById('game-screen');
                const startScreen = document.getElementById('start-screen');
                const profileScreen = document.getElementById('profile-screen');
                
                if (startScreen) startScreen.style.display = 'none';
                if (profileScreen) profileScreen.style.display = 'none';
                if (gameScreen) gameScreen.style.display = 'block';
                
                console.log('‚úÖ Screens forced');
                
                // 2. Set up game variables (only if starting fresh)
                if (!window.gameInProgress) {
                    window.timeLeft = 90;
                    window.currentLevel = 1;
                    window.currentScore = 0;
                    window.formsCompleted = 0;
                    window.gameInProgress = true;
                    console.log('üéÆ Starting fresh game - Level 1');
                } else {
                    console.log(`üéÆ Continuing game - Level ${window.currentLevel}`);
                }
                
                // 3. Force update UI
                const scoreEl = document.getElementById('score');
                const levelEl = document.getElementById('level');
                const timerEl = document.getElementById('timer');
                const completedEl = document.getElementById('completed');
                
                if (scoreEl) scoreEl.textContent = window.currentScore || 0;
                if (levelEl) levelEl.textContent = window.currentLevel || 1;
                if (timerEl) timerEl.textContent = window.timeLeft || 90;
                if (completedEl) completedEl.textContent = window.formsCompleted || 0;
                
                console.log('‚úÖ UI forced');
                
                // Get player info
                const savedProfile = localStorage.getItem('taxProUser');
                let playerName = 'Player';
                let playerAvatar = 'üë§';
                
                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    playerName = profile.name || 'Player';
                    playerAvatar = profile.avatar || 'üë§';
                }
                
                // Different forms AND data for different levels
                const levelData = {
                    1: { 
                        form: 'IRS Form 941 - Federal Quarterly Tax Return', 
                        state: 'Federal',
                        company: 'Gusto Payroll Solutions',
                        ein: '94-1234567',
                        wages: '125000.00',
                        fedTax: '18750.00',
                        ssTax: '7750.00',
                        medTax: '1812.50'
                    },
                    2: { 
                        form: 'California DE 9 - State Quarterly Report', 
                        state: 'California',
                        company: 'Gusto California Inc',
                        ein: '77-9876543',
                        wages: '98500.00',
                        fedTax: '14775.00',
                        ssTax: '6107.00',
                        medTax: '1428.25'
                    },
                    3: { 
                        form: 'New York NYS-45 - State Withholding Report', 
                        state: 'New York',
                        company: 'Gusto NY Solutions',
                        ein: '33-5555678',
                        wages: '156000.00',
                        fedTax: '23400.00',
                        ssTax: '9672.00',
                        medTax: '2262.00'
                    },
                    4: { 
                        form: 'Texas C-3 - State Employer Tax Report', 
                        state: 'Texas',
                        company: 'Gusto Texas Corp',
                        ein: '88-4444321',
                        wages: '89200.00',
                        fedTax: '13380.00',
                        ssTax: '5530.40',
                        medTax: '1293.40'
                    },
                    5: { 
                        form: 'Illinois UI-3/40 - State Wage Report', 
                        state: 'Illinois',
                        company: 'Gusto Illinois LLC',
                        ein: '55-7777890',
                        wages: '203000.00',
                        fedTax: '30450.00',
                        ssTax: '12586.00',
                        medTax: '2943.50'
                    }
                };
                
                const currentFormLevel = ((window.currentLevel - 1) % 5) + 1;
                const currentData = levelData[currentFormLevel];
                
                console.log(`üéØ Level ${window.currentLevel} - Form Level ${currentFormLevel} - ${currentData.form}`);
                console.log(`üìä Data for level: EIN=${currentData.ein}, Wages=${currentData.wages}`);
                
                // Update PANDA reference board with current level data
                updatePandaReference(currentData);
                
                // 4. FORCE CREATE SIMPLE FORM (no quarter!)
                const formElement = document.getElementById('current-form');
                if (formElement) {
                    formElement.innerHTML = `
                        <div style="background: white; padding: 20px; border: 2px solid #ddd; border-radius: 10px;">
                            <h2>${playerAvatar} ${playerName} - Level ${window.currentLevel}</h2>
                            <h3 style="color: #2196F3; margin: 10px 0;">${currentData.form}</h3>
                            <p style="color: #666; margin: 10px 0; font-weight: bold;">${currentData.state} Form - ${currentData.company}</p>
                            <div style="margin: 15px 0;">
                                <label style="display: block; font-weight: bold;">EIN:</label>
                                <input type="text" id="simple-field-0" value="" placeholder="${currentData.ein}" 
                                       style="width: 200px; padding: 10px; border: 2px solid #ccc; font-size: 16px;">
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; font-weight: bold;">Total Wages:</label>
                                <input type="text" id="simple-field-1" value="" placeholder="${currentData.wages}" 
                                       style="width: 200px; padding: 10px; border: 2px solid #ccc; font-size: 16px;">
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; font-weight: bold;">Federal Income Tax:</label>
                                <input type="text" id="simple-field-2" value="" placeholder="${currentData.fedTax}" 
                                       style="width: 200px; padding: 10px; border: 2px solid #ccc; font-size: 16px;">
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; font-weight: bold;">Social Security Tax:</label>
                                <input type="text" id="simple-field-3" value="" placeholder="${currentData.ssTax}" 
                                       style="width: 200px; padding: 10px; border: 2px solid #ccc; font-size: 16px;">
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; font-weight: bold;">Medicare Tax:</label>
                                <input type="text" id="simple-field-4" value="" placeholder="${currentData.medTax}" 
                                       style="width: 200px; padding: 10px; border: 2px solid #ccc; font-size: 16px;">
                            </div>
                            <button id="simple-submit" onclick="simpleSubmit()" 
                                    style="display: none; padding: 15px 25px; background: #4CAF50; color: white; border: none; font-size: 18px; cursor: pointer; border-radius: 5px; margin: 10px;">
                                üöÄ SUBMIT FORM
                            </button>
                            <button onclick="exitToProfile()" 
                                    style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; font-size: 14px; cursor: pointer; border-radius: 5px; margin: 10px;">
                                üö™ Exit to Profile
                            </button>
                        </div>
                    `;
                    console.log('‚úÖ Simple form forced (NO QUARTER)');
                    
                    // Add validation to inputs with current level's correct answers
                    const answers = [currentData.ein, currentData.wages, currentData.fedTax, currentData.ssTax, currentData.medTax];
                    const inputs = [
                        document.getElementById('simple-field-0'),
                        document.getElementById('simple-field-1'),
                        document.getElementById('simple-field-2'),
                        document.getElementById('simple-field-3'),
                        document.getElementById('simple-field-4')
                    ];
                    
                    console.log(`‚úÖ Level ${window.currentLevel} correct answers:`, answers);
                    
                    inputs.forEach((input, i) => {
                        if (input) {
                            // Make sure field is enabled
                            input.disabled = false;
                            input.readOnly = false;
                            
                            input.addEventListener('input', () => {
                                const val = input.value.trim();
                                console.log(`Simple field ${i}: "${val}" vs "${answers[i]}"`);
                                
                                if (val === answers[i]) {
                                    input.style.border = '3px solid #00ff00';
                                    input.style.background = '#f0fff0';
                                } else if (val !== '') {
                                    input.style.border = '3px solid #ff0000';
                                    input.style.background = '#fff0f0';
                                } else {
                                    input.style.border = '2px solid #ccc';
                                    input.style.background = 'white';
                                }
                                
                                // Check if all correct
                                let allCorrect = true;
                                let allFilled = true;
                                inputs.forEach((inp, j) => {
                                    if (!inp.value.trim()) allFilled = false;
                                    if (inp.value.trim() !== answers[j]) allCorrect = false;
                                });
                                
                                const btn = document.getElementById('simple-submit');
                                if (allFilled && btn) {
                                    btn.style.display = 'block';
                                    btn.textContent = allCorrect ? 'üöÄ SUBMIT - PERFECT!' : '‚ö†Ô∏è SUBMIT ANYWAY';
                                    btn.style.background = allCorrect ? '#4CAF50' : '#ff9800';
                                }
                            });
                        }
                    });
                }
                
                // 5. FORCE START TIMER
                if (window.forceTimer) clearInterval(window.forceTimer);
                window.forceTimer = setInterval(() => {
                    window.timeLeft--;
                    console.log('FORCE TIMER:', window.timeLeft);
                    
                    const timerEl = document.getElementById('timer');
                    if (timerEl) timerEl.textContent = window.timeLeft;
                    
                    if (window.timeLeft <= 0) {
                        clearInterval(window.forceTimer);
                        alert('‚è∞ Time up!');
                    }
                }, 1000);
                
                console.log('üö® FORCE SIMPLE GAME COMPLETE - Try typing in the fields!');
            }
            
            // Update PANDA reference board with current level data
            function updatePandaReference(levelData) {
                console.log('üìã Updating PANDA reference with:', levelData);
                
                // Update PANDA board content
                const pandaBoard = document.querySelector('.panda-content');
                if (pandaBoard) {
                    pandaBoard.innerHTML = `
                        <h4>üìä ${levelData.form}</h4>
                        <p style="color: #666; margin-bottom: 15px;"><strong>${levelData.company}</strong></p>
                        
                        <div class="panda-field" style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <strong>EIN (Employer ID):</strong><br>
                            <code style="font-size: 16px; color: #d32f2f; font-weight: bold;">${levelData.ein}</code>
                        </div>
                        
                        <div class="panda-field" style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <strong>Total Wages:</strong><br>
                            <code style="font-size: 16px; color: #d32f2f; font-weight: bold;">$${levelData.wages}</code>
                        </div>
                        
                        <div class="panda-field" style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <strong>Federal Income Tax:</strong><br>
                            <code style="font-size: 16px; color: #d32f2f; font-weight: bold;">$${levelData.fedTax}</code>
                        </div>
                        
                        <div class="panda-field" style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <strong>Social Security Tax:</strong><br>
                            <code style="font-size: 16px; color: #d32f2f; font-weight: bold;">$${levelData.ssTax}</code>
                        </div>
                        
                        <div class="panda-field" style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 5px;">
                            <strong>Medicare Tax:</strong><br>
                            <code style="font-size: 16px; color: #d32f2f; font-weight: bold;">$${levelData.medTax}</code>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; border: 1px solid #2196f3;">
                            <small><strong>üí° Copy these values EXACTLY into the form!</strong></small>
                        </div>
                    `;
                    console.log('‚úÖ PANDA board updated successfully');
                } else {
                    console.log('‚ö†Ô∏è PANDA board element not found');
                }
            }
            
            // Simple submit function
            function simpleSubmit() {
                console.log('üöÄ Simple submit!');
                window.currentScore += 100;
                window.currentLevel++;
                window.formsCompleted++;
                window.timeLeft += 15;
                
                // Get next form info for the alert
                const nextLevelData = {
                    1: { form: 'IRS Form 941 - Federal Quarterly Tax Return', company: 'Gusto Payroll Solutions', state: 'Federal' },
                    2: { form: 'California DE 9 - State Quarterly Report', company: 'Gusto California Inc', state: 'California' },
                    3: { form: 'New York NYS-45 - State Withholding Report', company: 'Gusto NY Solutions', state: 'New York' },
                    4: { form: 'Texas C-3 - State Employer Tax Report', company: 'Gusto Texas Corp', state: 'Texas' },
                    5: { form: 'Illinois UI-3/40 - State Wage Report', company: 'Gusto Illinois LLC', state: 'Illinois' }
                };
                
                const nextFormLevel = ((window.currentLevel - 1) % 5) + 1;
                const nextForm = nextLevelData[nextFormLevel];
                
                alert(`üéâ Level Complete! 
Score: ${window.currentScore}
Next: Level ${window.currentLevel} - ${nextForm.form}
Company: ${nextForm.company} (${nextForm.state})
+15 seconds bonus time!`);
                
                // Update UI immediately
                const scoreEl = document.getElementById('score');
                const levelEl = document.getElementById('level');
                const completedEl = document.getElementById('completed');
                const timerEl = document.getElementById('timer');
                
                if (scoreEl) scoreEl.textContent = window.currentScore;
                if (levelEl) levelEl.textContent = window.currentLevel;
                if (completedEl) completedEl.textContent = window.formsCompleted;
                if (timerEl) timerEl.textContent = window.timeLeft;
                
                console.log(`‚úÖ Level advanced to ${window.currentLevel}`);
                
                // Update saved profile with best score
                const savedProfile = localStorage.getItem('taxProUser');
                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    if (window.currentScore > profile.bestScore) {
                        profile.bestScore = window.currentScore;
                        localStorage.setItem('taxProUser', JSON.stringify(profile));
                        console.log('üèÜ New best score saved!');
                    }
                }
                
                // Create new form with updated level
                console.log(`üîÑ Creating new form for level ${window.currentLevel}`);
                setTimeout(() => forceSimpleGame(), 1000);
            }
            
            // Exit to profile function
            function exitToProfile() {
                console.log('üö™ Exiting to profile...');
                
                // Stop timer
                if (window.forceTimer) {
                    clearInterval(window.forceTimer);
                    console.log('‚è∞ Timer stopped');
                }
                
                // Reset game progress flag
                window.gameInProgress = false;
                
                // Show profile screen
                showProfileScreen();
                
                // Reset game state
                window.timeLeft = 90;
                window.currentLevel = 1;
                window.currentScore = 0;
                window.formsCompleted = 0;
                
                console.log('‚úÖ Returned to profile screen');
            }
            
            // Remove automatic form creation - will be handled by game start only

            // Remove complex overrides - keep it simple

            // Simple fillForm function - form fields are always ready
            window.fillForm = function() {
                console.log('üöÄ fillForm() called - form is already ready!');
                
                // Set form state
                window.formState = 'filled';
                formState = 'filled';
                
                // Focus first input if available
                const firstInput = document.querySelector('#current-form input');
                if (firstInput) {
                    firstInput.focus();
                    console.log('‚úÖ Focused first input field');
                }
                
                console.log('‚úÖ Form ready to use!');
            };
            
            // Update submit button based on validation
            function updateSubmitButton(isValid) {
                const submitBtn = document.getElementById('submit-form-btn');
                if (submitBtn) {
                    if (isValid) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                        submitBtn.title = '‚úÖ All answers are correct! Click to submit.';
                        submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.5';
                        submitBtn.style.cursor = 'not-allowed';
                        submitBtn.title = '‚ùå Please correct all red highlighted fields before submitting.';
                        submitBtn.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
                    }
                }
            }
            
            // Show validation summary
            function showValidationSummary(validation) {
                const summary = document.createElement('div');
                summary.id = 'validation-summary';
                summary.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${validation.allCorrect ? '#4CAF50' : '#f44336'};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-weight: bold;
                    text-align: center;
                    max-width: 80%;
                `;
                
                if (validation.allCorrect) {
                    summary.innerHTML = '‚úÖ All answers are correct! You can now submit the form.';
                } else {
                    summary.innerHTML = `‚ùå ${validation.errors.length} field(s) need correction. Check the red highlighted fields.`;
                }
                
                // Remove existing summary
                const existingSummary = document.getElementById('validation-summary');
                if (existingSummary) existingSummary.remove();
                
                document.body.appendChild(summary);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (summary.parentNode) summary.remove();
                }, 3000);
            }
            
            
            
        </script>
</body>
</html>
